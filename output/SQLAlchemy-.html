<!doctype html>
<html lang="">	
<head>
	<meta charset="utf-8"/>
	<title>SQLAlchemy - char stream</title>	
	<meta name="author" content="Shreesh Ayachit">
	
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0">
	
	<link href='http://fonts.googleapis.com/css?family=Droid+Sans:700,400|Droid+Sans+Mono' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
		
	<!--[if lt IE 9]>
		<script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	
			
	<link href="./" type="application/atom+xml" rel="alternate" title="char stream ATOM Feed" />
	</head>
	
<body>		
	<header class="clearfix" role="banner">
		<div class="wrapper">
			<h1 class="huge"><a href=".">char stream</a></h1>
		</div>
	</header>
	
	<div role="main" class="content clearfix">	
	<article>
		<div class="post wrapper">
			<h1>SQLAlchemy</h1>
			<div class="section" id="me-no-wants-mysql-statements">
<h2>Me no wants mySQL statements</h2>
<p>ORM simply put;lets you define classes which get mapped to tables(relations) in
[my]SQL. Thats perfect If you are used to working with classes in C++ as
I am. You just define class and add class members which correspond to
the attributes of a table. The Fun part is, you can use inheritance to
map related tables.</p>
<p>I use <a class="reference external" href="http://flask.pocoo.org/">Flask</a> as my Web Framework. Armin has
written a convenient wrapper FLask_SQLAlchemy. It takes away many of
the headaches of using SQLAlchemy and gives a single class interface.</p>
<div class="section" id="user-activity-table">
<h3>User Activity Table</h3>
<p>Say you want to create a table called 'useractivity' which every user
activity. But usually there can be more than one 'type' of user
activity, like user checking into a place OR user making a comment on a
checking. So, In OO methodology, We need a generic UserActivity class;
and two derived classes: PlaceActivity and ConversationActivity. You
would declare the following classes:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">UserActivity</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;useractivity&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">date_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">lng</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">}</span>
<span class="k">class</span> <span class="nc">PlaceActivity</span><span class="p">(</span><span class="n">UserActivity</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;place&#39;</span><span class="p">}</span>
    <span class="n">__public__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;type_id&#39;</span><span class="p">,</span><span class="s">&#39;date_time&#39;</span><span class="p">,</span><span class="s">&#39;points&#39;</span><span class="p">,</span><span class="s">&#39;message&#39;</span><span class="p">,</span><span class="s">&#39;lat&#39;</span><span class="p">,</span><span class="s">&#39;lng&#39;</span><span class="p">]</span>
    <span class="n">place_type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;placetype.id&#39;</span><span class="p">))</span>
    <span class="n">place_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">place_points</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">place_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">date_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lng</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">UserActivity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="p">,</span><span class="n">date_time</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">lng</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_id</span> <span class="o">=</span> <span class="n">place_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_type</span> <span class="o">=</span> <span class="n">Place</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">place_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">type_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_points</span> <span class="o">=</span> <span class="n">PlaceType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">place_type</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">points</span>
<span class="k">class</span> <span class="nc">ConversationActivity</span><span class="p">(</span><span class="n">UserActivity</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;conversation&#39;</span><span class="p">}</span>
    <span class="n">__public__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span><span class="s">&#39;user_id&#39;</span><span class="p">,</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;type_id&#39;</span><span class="p">,</span><span class="s">&#39;date_time&#39;</span><span class="p">,</span><span class="s">&#39;points&#39;</span><span class="p">,</span><span class="s">&#39;message&#39;</span><span class="p">,</span><span class="s">&#39;lat&#39;</span><span class="p">,</span><span class="s">&#39;lng&#39;</span><span class="p">]</span>
    <span class="n">conv_type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;convotypes.id&#39;</span><span class="p">))</span>
    <span class="n">conv_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">conv_points</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">conv_result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">conv_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">date_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lng</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">UserActivity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="p">,</span><span class="n">date_time</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">lng</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_id</span> <span class="o">=</span> <span class="n">conv_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_type</span> <span class="o">=</span> <span class="n">Conversation</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">conv_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">type_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_points</span>  <span class="o">=</span> <span class="n">ConversationType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_type</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">points</span>
</pre></div>
<p>(I have omitted unrelated classes like ConversationType and PlaceType).
The key lines here is:</p>
<div class="highlight"><pre><span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;conversation&#39;</span><span class="p">}</span>
<span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;place&#39;</span><span class="p">}</span>
</pre></div>
<p>ORM works by 'mapping' user defined classes to the database tables. By
default, the class members are made table attributes with the variable
names as the attribute name. In the above table we are trying to make
the attribute 'type' polymorphic i.e the variable value will depend on
the class object its called from.</p>
<p>So, Now you can insert either a Conversation Or Place Activity</p>
<div class="highlight"><pre><span class="n">placeActivity</span> <span class="o">=</span> <span class="n">PlaceActivity</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">convert_int</span><span class="p">(</span><span class="n">place_id</span><span class="p">),</span><span class="n">date_time</span><span class="p">,</span><span class="n">convert_float</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span><span class="n">convert_float</span><span class="p">(</span><span class="n">lng</span><span class="p">))</span>
<span class="n">convActivity</span> <span class="o">=</span> <span class="n">ConversationActivity</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">pickupline_id</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date_time</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
<p>Neat.</p>
</div>
</div>

			<a href="https://twitter.com/share" class="twitter-share-button" data-via="" data-lang="en" data-count="none"  data-related="">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
      <br/>	
						
						
		</div>
	
	<div class="meta wrapper">
	<time datetime="2011-03-23T00:00:00" pubdate>Wed, 23 Mar 2011</time>
	<ul class="tag clearfix">
		<li><a href="./category/code.html">code</a></li>
	</ul>
	</div>	</article>	
</div>
	
  <hr>		
<footer class="clearfix">
	<div class="wrapper pages">
		<ul class="nav">
					<li><a href="./archives.html">archive</a></li>
			<li><a href="./about.html">about</a></li>
			<li><a href="./ios-apps.html">apps</a></li>
			<li><a href="./bart.html">bart</a></li>
		</ul>
	</div>
	
	<div class="copy wrapper">
		<ul class="social">
						<li><a href="http://twitter.com/shreeshga">twitter</a></li>
						<li><a href="http://github.com/shreeshga">github</a></li>
						<li><a href="https://www.quora.com/Shreesh-Ayachit">quora</a></li>
						<li><a href="https://plus.google.com/107491169271722959755/">plus</a></li>
					</ul>
	
		</div>
</footer>
	
	<script>
	  var _gaq=[['_setAccount',''],['_trackPageview']];
	  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
	  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
	  s.parentNode.insertBefore(g,s)}(document,'script'));
	</script>
</body>
</html>