
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />

        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.0r4/build/reset-fonts-grids/reset-fonts-grids.css"> 
        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.0r4/build/base/base-min.css">

        <link rel="stylesheet" href="http://shreesh.in/css/style.css" type="text/css" />
        

        <title>Shreesh Ayachit</title>

        <script type="text/javascript">
        
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-6341348-3']);
          _gaq.push(['_trackPageview']);
        
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        
        </script>
    </head>
    <body>
        <div id="doc4" class="yui-t2">
            <div id="hd">
                <h1 class="title">
                    <a href="http://shreesh.in/" title="Home">
                        char stream
                    </a>
                </h1>
                <div class="tagline">A blog powered by Free & Open  Internet</div>
            </div><!-- hd -->
            <div id="bd">
                <div id="yui-main">
                    <div class="yui-b">
    <div class="entry">
    <div class="header">
        <h2><a href="http://shreesh.in/2011/03/23/SQLAlchemy-/">Me no wants mySQL statements</a></h2>
        <div class="metadata">
            <div class="authorship">
                <span class="author">Posted by Shreesh on March 23, 2011 at 20:13 PM</span>
                <!--<img class="license" alt="" src= "cc-by-sa.png" />-->
            </div><!-- authorship -->
        </div><!-- metadata -->
    </div><!-- header -->

    <div class="content">
        <p>ORM simply put;lets you define classes which get mapped to tables(relations) in
[my]SQL. Thats perfect If you are used to working with classes in C++ as
I am. You just define class and add class members which correspond to
the attributes of a table. The Fun part is, you can use inheritance to
map related tables.</p>
<p>I use <a class="reference external" href="http://flask.pocoo.org/">Flask</a> as my Web Framework. Armin has
written a convenient wrapper FLask_SQLAlchemy. It takes away many of
the headaches of using SQLAlchemy and gives a single class interface.</p>
<div class="section" id="user-activity-table">
<h1>User Activity Table</h1>
<p>Say you want to create a table called 'useractivity' which every user
activity. But usually there can be more than one 'type' of user
activity, like user checking into a place OR user making a comment on a
checking. So, In OO methodology, We need a generic UserActivity class;
and two derived classes: PlaceActivity and ConversationActivity. You
would declare the following classes:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">UserActivity</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'useractivity'</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">'user.id'</span><span class="p">))</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">date_time</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">2000</span><span class="p">))</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">lng</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">'polymorphic_on'</span><span class="p">:</span> <span class="nb">type</span><span class="p">}</span>
<span class="k">class</span> <span class="nc">PlaceActivity</span><span class="p">(</span><span class="n">UserActivity</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">'polymorphic_identity'</span><span class="p">:</span> <span class="s">'place'</span><span class="p">}</span>
    <span class="n">__public__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'id'</span><span class="p">,</span><span class="s">'user_id'</span><span class="p">,</span><span class="s">'type'</span><span class="p">,</span><span class="s">'type_id'</span><span class="p">,</span><span class="s">'date_time'</span><span class="p">,</span><span class="s">'points'</span><span class="p">,</span><span class="s">'message'</span><span class="p">,</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lng'</span><span class="p">]</span>
    <span class="n">place_type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">'placetype.id'</span><span class="p">))</span>
    <span class="n">place_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">place_points</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">place_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">date_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lng</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">UserActivity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="p">,</span><span class="n">date_time</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">lng</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_id</span> <span class="o">=</span> <span class="n">place_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_type</span> <span class="o">=</span> <span class="n">Place</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">place_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">type_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_points</span> <span class="o">=</span> <span class="n">PlaceType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">place_type</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">points</span>
<span class="k">class</span> <span class="nc">ConversationActivity</span><span class="p">(</span><span class="n">UserActivity</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">'polymorphic_identity'</span><span class="p">:</span> <span class="s">'conversation'</span><span class="p">}</span>
    <span class="n">__public__</span> <span class="o">=</span> <span class="p">[</span><span class="s">'id'</span><span class="p">,</span><span class="s">'user_id'</span><span class="p">,</span><span class="s">'type'</span><span class="p">,</span><span class="s">'type_id'</span><span class="p">,</span><span class="s">'date_time'</span><span class="p">,</span><span class="s">'points'</span><span class="p">,</span><span class="s">'message'</span><span class="p">,</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lng'</span><span class="p">]</span>
    <span class="n">conv_type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span><span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">'convotypes.id'</span><span class="p">))</span>
    <span class="n">conv_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">conv_points</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">conv_result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">conv_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">result</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">date_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">lng</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">UserActivity</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user_id</span><span class="p">,</span><span class="n">date_time</span><span class="p">,</span><span class="n">lat</span><span class="p">,</span><span class="n">lng</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_id</span> <span class="o">=</span> <span class="n">conv_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_type</span> <span class="o">=</span> <span class="n">Conversation</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">conv_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">type_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_points</span>  <span class="o">=</span> <span class="n">ConversationType</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_type</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">points</span>
</pre>
<p>(I have omitted unrelated classes like ConversationType and PlaceType).
The key lines here is:</p>
<pre class="code python literal-block">
<span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">'polymorphic_identity'</span><span class="p">:</span> <span class="s">'conversation'</span><span class="p">}</span>
<span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">'polymorphic_identity'</span><span class="p">:</span> <span class="s">'place'</span><span class="p">}</span>
</pre>
<p>ORM works by 'mapping' user defined classes to the database tables. By
default, the class members are made table attributes with the variable
names as the attribute name. In the above table we are trying to make
the attribute 'type' polymorphic i.e the variable value will depend on
the class object its called from.</p>
<p>So, Now you can insert either a Conversation Or Place Activity</p>
<pre class="code python literal-block">
<span class="n">placeActivity</span> <span class="o">=</span> <span class="n">PlaceActivity</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">convert_int</span><span class="p">(</span><span class="n">place_id</span><span class="p">),</span><span class="n">date_time</span><span class="p">,</span><span class="n">convert_float</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span><span class="n">convert_float</span><span class="p">(</span><span class="n">lng</span><span class="p">))</span>
<span class="n">convActivity</span> <span class="o">=</span> <span class="n">ConversationActivity</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">pickupline_id</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">date_time</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
</pre>
<p>Neat.</p>
</div>

    </div><!-- content -->
</div><!-- entry -->

                    </div><!-- yui-b -->
                </div><!-- yui-main -->
                                <div class="yui-b sidebar">
                    <div class="sidebox">
                        <h2>Other Links</h2>
                        <ul>
                            <li><a href="http://shreesh.in/about/">About</a></li>
                            <li><a href="http://shreesh.in/projects/">Projects</a></li>
                            <li><a href="http://prerna.shreesh.in">Wedding Site</a></li>
                            <li><a href="http://charles.shreesh.in">My River</a></li>
                            <li><a href="http://shreesh.in/bart-blackboard/">Bart's blackboard</a></li>
                            
                        </ul>
                    </div><!-- sidebox -->
                <div class="sidebox">
    <h2>Recent Posts</h2>
    <ul>
        <li><a href="http://shreesh.in/2013/02/08/River-of-News/">River of News</a></li>
        
        <li><a href="http://shreesh.in/2012/12/08/Wedding-Site/">The art of creating wedding invitations</a></li>
        
        <li><a href="http://shreesh.in/2012/10/26/Code/">Code</a></li>
        
        <li><a href="http://shreesh.in/2012/10/03/Product-Obsession/">About the Android UI Design Guidelines</a></li>
        
        <li><a href="http://shreesh.in/2012/08/07/The-Case-against-Apple/">Google &gt; Apple</a></li>
        
        <li><a href="http://shreesh.in/2012/08/06/Heres-to-Human-Curiosity/">Here's to Human Curiosity</a></li>
        
        <li><a href="http://shreesh.in/2012/07/26/Future-Is-Boring/">The Future is boring</a></li>
        
        <li><a href="http://shreesh.in/2012/01/17/Cornell-Meng-Guide/">Cornell MEng CS Survival guide</a></li>
        
        <li><a href="http://shreesh.in/2011/12/27/2012-checklist/">2012  checklist</a></li>
        
        <li><a href="http://shreesh.in/2011/12/06/Stuff-I-learnt-in-4-months/">Stuff I learnt in 4 months</a></li>
        
    </ul>
</div><!-- sidebox -->

                
<div class="sidebox">
    <h2>Daily Archives</h2>
    <ul>
        <li><a href="http://shreesh.in/2013/02/08/">February 08, 2013</a></li>
        
        <li><a href="http://shreesh.in/2012/12/08/">December 08, 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/10/26/">October 26, 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/10/03/">October 03, 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/08/07/">August 07, 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/08/06/">August 06, 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/07/26/">July 26, 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/01/17/">January 17, 2012</a></li>
        
        <li><a href="http://shreesh.in/2011/12/27/">December 27, 2011</a></li>
        
        <li><a href="http://shreesh.in/2011/12/06/">December 06, 2011</a></li>
        
    </ul>
</div><!-- sidebox -->

                
<div class="sidebox">
    <h2>Monthly Archives</h2>
    <ul>
        <li><a href="http://shreesh.in/2013/02/">February 2013</a></li>
        
        <li><a href="http://shreesh.in/2012/12/">December 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/10/">October 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/08/">August 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/07/">July 2012</a></li>
        
        <li><a href="http://shreesh.in/2012/01/">January 2012</a></li>
        
        <li><a href="http://shreesh.in/2011/12/">December 2011</a></li>
        
        <li><a href="http://shreesh.in/2011/10/">October 2011</a></li>
        
        <li><a href="http://shreesh.in/2011/08/">August 2011</a></li>
        
        <li><a href="http://shreesh.in/2011/03/">March 2011</a></li>
        
    </ul>
</div><!-- sidebox -->

                
<div class="sidebox">
    <h2>Yearly Archives</h2>
    <ul>
        <li><a href="http://shreesh.in/2013/">2013</a></li>
        
        <li><a href="http://shreesh.in/2012/">2012</a></li>
        
        <li><a href="http://shreesh.in/2011/">2011</a></li>
        
        <li><a href="http://shreesh.in/2010/">2010</a></li>
        
        <li><a href="http://shreesh.in/2009/">2009</a></li>
        
        <li><a href="http://shreesh.in/2007/">2007</a></li>
        
        <li><a href="http://shreesh.in/2006/">2006</a></li>
        
    </ul>
</div><!-- sidebox -->

                
                </div><!-- yui-b sidebar-->
            </div><!-- bd -->
            <div id="ft">
                <p>Shreesh Ayachit &brvbar; with Python &amp; Vim </p>
            </div><!-- ft -->
        </div><!-- doc3 -->
    </body>
</html>